name: Terraform Validate
permissions:
  contents: read
on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'terraform/**/*.tf'

jobs:
  find-terraform-dirs:
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.find-dirs.outputs.dirs }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      
      - name: Find all terraform directories
        id: find-dirs
        run: |
          DIRS=$(find terraform -name "*.tf" -not -path "*/.terraform/*" -exec dirname {} \; | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "dirs=$DIRS" >> $GITHUB_OUTPUT
          echo "Found $(echo $DIRS | jq 'length') terraform directories"

  validate:
    needs: find-terraform-dirs
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.find-terraform-dirs.outputs.dirs) }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      
      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
      
      - name: Terraform Init
        working-directory: ${{ matrix.dir }}
        run: terraform init -backend=false
      
      - name: Terraform Validate
        working-directory: ${{ matrix.dir }}
        run: terraform validate

  verify-all-dirs-validated:
    needs: [find-terraform-dirs, validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      
      - name: Verify all directories were validated
        run: |
          EXPECTED_DIRS=$(find terraform -name "*.tf" -not -path "*/.terraform/*" -exec dirname {} \; | sort -u | wc -l)
          VALIDATED_DIRS='${{ needs.find-terraform-dirs.outputs.dirs }}' 
          VALIDATED_COUNT=$(echo $VALIDATED_DIRS | jq 'length')
          
          echo "Expected directories: $EXPECTED_DIRS"
          echo "Validated directories: $VALIDATED_COUNT"
          
          if [ "$EXPECTED_DIRS" != "$VALIDATED_COUNT" ]; then
            echo "❌ Mismatch in terraform directory count!"
            echo "This likely means new terraform directories were added but not validated."
            exit 1
          fi
          
          echo "✅ All terraform directories were validated"
      
      - name: Check validation results
        run: |
          if [ "${{ needs.validate.result }}" != "success" ]; then
            echo "❌ Terraform validation failed"
            exit 1
          fi
          echo "✅ All terraform validations passed"
